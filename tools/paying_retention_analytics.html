<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paying User Retention _ by. MGT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .upload-area.dragover {
            border-color: #ff6b6b;
            background: #ffe5e5;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: #ff8787;
            color: white;
        }

        .btn-success:hover {
            background: #ff7070;
        }

        .btn-secondary {
            background: #ff6b81;
            color: white;
        }

        .btn-secondary:hover {
            background: #ff5270;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 15px;
            text-align: left;
        }

        .file-item {
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #2d3748;
            font-size: 32px;
            font-weight: 700;
        }

        .stat-unit {
            color: #a0aec0;
            font-size: 18px;
            font-weight: 400;
        }

        .chart-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .table-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        tr:hover {
            background: #f7fafc;
        }

        .retention-high {
            color: #e85d75;
            font-weight: 600;
        }

        .retention-medium {
            color: #ff8787;
            font-weight: 600;
        }

        .retention-low {
            color: #ffb3b3;
            font-weight: 600;
        }

        .info-section {
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 10px 0;
        }

        .info-icon {
            font-size: 24px;
        }

        .info-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            flex: 1;
        }

        .toggle-icon {
            color: #ff6b6b;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .info-content {
            margin-top: 15px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .info-content.hidden {
            max-height: 0;
            margin-top: 0;
        }

        .info-block {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .info-block h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .info-block ul {
            margin-left: 20px;
        }

        .info-block li {
            margin-bottom: 8px;
            color: #4a5568;
            line-height: 1.6;
        }

        .info-block li ul {
            margin-top: 6px;
            margin-left: 20px;
        }

        .info-block li ul li {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .info-block strong {
            color: #2d3748;
        }

        .info-block.warning {
            background: #fff5f5;
            border-left: 4px solid #f56565;
        }

        .info-block.solution {
            background: #fff5f7;
            border-left: 4px solid #ff8787;
        }

        .info-block.tip {
            background: #fffaf0;
            border-left: 4px solid #ff6b81;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .download-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cohort-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .cohort-table th,
        .cohort-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            min-width: 80px;
        }

        .cohort-table th {
            background: #f7fafc;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cohort-table th:first-child {
            text-align: left;
            min-width: 120px;
        }

        .cohort-table td:first-child {
            text-align: left;
            font-weight: 600;
            background: #f7fafc;
        }

        .cohort-cell {
            cursor: pointer;
            transition: all 0.2s;
        }

        .cohort-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cohort-high {
            background: #ffc9d0;
            color: #8b1e3f;
        }

        .cohort-medium {
            background: #ffe0e5;
            color: #c73866;
        }

        .cohort-low {
            background: #fff5f7;
            color: #8b7a7f;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š Paying User Retention _ by. MGT</h1>
            <p class="subtitle">ì¼ë³„ Â· ì£¼ë³„ Â· ì›”ë³„ êµ¬ë§¤ì ì¬êµ¬ë§¤ìœ¨ ë¶„ì„</p>
        </header>

        <!-- í•œê³„ì  ë° ì‚¬ìš© ê°€ì´ë“œ -->
        <div class="info-section">
            <div class="info-header" onclick="toggleInfo()">
                <span class="info-icon">ğŸ’¡</span>
                <span class="info-title">ë°ì´í„° í•œê³„ì  ë° ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•</span>
                <span id="infoToggle" class="toggle-icon">â–¼</span>
            </div>
            <div id="infoContent" class="info-content hidden">
                <div class="info-block warning">
                    <h3>âš ï¸ ì£¼ìš” í•œê³„ì </h3>
                    <ul>
                        <li><strong>ì‹ ê·œ êµ¬ë§¤ì ì‹ë³„ ë¶ˆê°€:</strong> ì—…ë¡œë“œí•œ ë°ì´í„° ë‚´ì—ì„œ ê°€ì¥ ì´ë¥¸ êµ¬ë§¤ì¼ì„ "ì²« êµ¬ë§¤"ë¡œ ê°€ì •í•©ë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” ê·¸ ì´ì „ì—ë„ êµ¬ë§¤í•œ ê³ ê°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li><strong>êµ¬ë§¤ìë§Œ ì¶”ì :</strong> ë°©ë¬¸ë§Œ í•˜ê³  êµ¬ë§¤í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ì¸¡ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ëŠ” "êµ¬ë§¤ ì „í™˜ ê³ ê°ì˜ ì¬êµ¬ë§¤ìœ¨"ë§Œ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
                        <li><strong>ì½”í˜¸íŠ¸ ë¶„ì„ì˜ ì œì•½:</strong> ì—…ë¡œë“œ ê¸°ê°„ ì´ˆë°˜ì˜ ì½”í˜¸íŠ¸ëŠ” ê¸°ì¡´ ê³ ê°ì´ ë§ì´ ì„ì—¬ ìˆì–´ ì‹ ê·œ ê³ ê° ì¶”ì ìœ¼ë¡œ ë¶€ì í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
                
                <div class="info-block solution">
                    <h3>âœ… í˜„ì‹¤ì ì¸ í•´ê²° ë°©ë²•</h3>
                    <ul>
                        <li><strong>ì¶©ë¶„íˆ ê¸´ ê¸°ê°„ ë°ì´í„° ì‚¬ìš© (ê¶Œì¥ â­):</strong>
                            <ul>
                                <li>ìµœì†Œ 3ê°œì›” ì´ìƒì˜ ë°ì´í„° ì—…ë¡œë“œ</li>
                                <li>1ê°œì›”ì°¨: ê¸°ì¡´ ê³ ê° ë§ì´ ì„ì„</li>
                                <li>2~3ê°œì›”ì°¨: ëŒ€ë¶€ë¶„ ì‹¤ì œ ì‹ ê·œ ê³ ê°ìœ¼ë¡œ ê°„ì£¼ ê°€ëŠ¥</li>
                                <li>â†’ 2~3ê°œì›”ì°¨ ì´í›„ì˜ ì½”í˜¸íŠ¸ ë°ì´í„°ê°€ ì˜ë¯¸ ìˆìŒ</li>
                            </ul>
                        </li>
                        <li><strong>íŠ¸ë Œë“œ ë¶„ì„ì— í™œìš©:</strong>
                            <ul>
                                <li>ì ˆëŒ€ê°’ë³´ë‹¤ëŠ” ë¦¬í…ì…˜ìœ¨ì˜ ë³€í™” ì¶”ì´ ê´€ì°°</li>
                                <li>ë§ˆì¼€íŒ… ìº í˜ì¸ ì „í›„ ë¹„êµ</li>
                                <li>ì‹œì¦Œë³„/ìš”ì¼ë³„ íŒ¨í„´ íŒŒì•…</li>
                            </ul>
                        </li>
                        <li><strong>ì •ê¸°ì  ë¶„ì„:</strong>
                            <ul>
                                <li>ë§¤ì›” ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸</li>
                                <li>ì´ì „ ë‹¬ ê²°ê³¼ì™€ ë¹„êµí•˜ì—¬ ê°œì„ /ì•…í™” í™•ì¸</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="info-block tip">
                    <h3>ğŸ“Œ í™œìš© íŒ</h3>
                    <ul>
                        <li>ì¼ë³„ ë¦¬í…ì…˜ì€ ìŠµê´€ì  êµ¬ë§¤ íŒ¨í„´ íŒŒì•…ì— ìœ ìš©</li>
                        <li>ì£¼ë³„ ë¦¬í…ì…˜ì€ í”„ë¡œëª¨ì…˜ íš¨ê³¼ ì¸¡ì •ì— ì í•©</li>
                        <li>ì›”ë³„ ë¦¬í…ì…˜ì€ ê³ ê° ì¶©ì„±ë„ ì¥ê¸° ì¶”ì„¸ ë¶„ì„ì— í™œìš©</li>
                        <li>ì½”í˜¸íŠ¸ ë¶„ì„ìœ¼ë¡œ íŠ¹ì • ì‹œê¸° ìœ ì… ê³ ê°ì˜ í’ˆì§ˆ í‰ê°€</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <h2 style="margin-bottom: 20px;">ğŸ“ ë°ì´í„° ì—…ë¡œë“œ</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <h3>ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)</h3>
                <p style="color: #ff6b6b; font-weight: 600; margin-top: 10px; font-size: 16px;">
                    âœ¨ Ctrl/Cmd ëˆ„ë¥´ê³  ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­
                </p>
                <p style="color: #718096; margin-top: 5px; font-size: 14px;">
                    ì˜ˆ: 25_01_total.xlsx, 25_02_total.xlsx, 25_03_total.xlsx ë™ì‹œ ì—…ë¡œë“œ
                </p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
            </div>

            <div style="margin-top: 20px; margin-bottom: 15px;">
                <div class="upload-area" id="jsonUploadArea" style="border-color: #cbd5e0; background: #f7fafc;">
                    <div class="upload-icon">ğŸ“‹</div>
                    <h3>ğŸ“‹ JSON íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)</h3>
                    <p style="color: #ff6b6b; font-weight: 600; margin-top: 10px; font-size: 16px;">
                        âœ¨ Ctrl/Cmd ëˆ„ë¥´ê³  ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­
                    </p>
                    <p style="color: #718096; margin-top: 5px; font-size: 14px;">
                        JSON íŒŒì¼ë§Œìœ¼ë¡œë„ ë¶„ì„ ê°€ëŠ¥ | ì—‘ì…€ê³¼ í•¨ê»˜ ì—…ë¡œë“œí•˜ë©´ ë°ì´í„° í†µí•©
                    </p>
                    <input type="file" id="jsonInput" accept=".json" multiple style="display: none;">
                </div>
            </div>

            <div class="file-list" id="fileList"></div>
            <div class="file-list" id="jsonFileList" style="margin-top: 10px;"></div>

            <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn" style="background: #ff8787; color: white;" onclick="document.getElementById('fileInput').click()">
                    â• íŒŒì¼ ë” ì¶”ê°€í•˜ê¸°
                </button>
                <button class="btn btn-primary" id="calculateBtn" disabled>
                    ğŸ”„ ë¦¬í…ì…˜ ê³„ì‚°í•˜ê¸°
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>
        </div>

        <div id="results" class="hidden">
            <!-- ë‚ ì§œ í•„í„°ë§ ì„¹ì…˜ -->
            <div class="upload-section" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #2d3748;">ğŸ” ë°ì´í„° ê¸°ê°„ í•„í„°ë§</h3>
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #4a5568;">ì‹œì‘ì¼</label>
                        <input type="date" id="filterStartDate" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #4a5568;">ì¢…ë£Œì¼</label>
                        <input type="date" id="filterEndDate" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="applyDateFilter()" style="padding: 10px 20px;">
                            âœ… í•„í„° ì ìš©
                        </button>
                        <button class="btn btn-secondary" onclick="resetDateFilter()" style="padding: 10px 20px;">
                            ğŸ”„ ì „ì²´ ë³´ê¸°
                        </button>
                    </div>
                </div>
                <p id="filterStatus" style="margin-top: 10px; font-size: 13px; color: #718096;"></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ë°ì´í„° ê¸°ê°„</div>
                    <div class="stat-value" id="dataPeriod" style="font-size: 20px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="stat-value" id="totalRecords">-</div>
                    <span class="stat-unit">ê±´</span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ìœ ë‹ˆí¬ êµ¬ë§¤ì</div>
                    <div class="stat-value" id="uniqueBuyers">-</div>
                    <span class="stat-unit">ëª…</span>
                </div>
                <div class="stat-card">
                    <div class="stat-label">í‰ê·  ë¦¬í…ì…˜ìœ¨</div>
                    <div class="stat-value" id="avgRetention">-</div>
                    <span class="stat-unit">%</span>
                </div>
            </div>

            <div class="chart-section">
                <h2 class="chart-title" style="font-size: 24px; margin-bottom: 10px;">ğŸ“ˆ ìˆœì°¨ ë¦¬í…ì…˜</h2>
                <p style="color: #718096; margin-bottom: 20px;">ì „ì¼/ì „ì£¼/ì „ì›” ëŒ€ë¹„ ì¬êµ¬ë§¤ìœ¨ ì¶”ì´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤ (ê¸°ì¤€ì´ ë§¤ë²ˆ ë³€ê²½ë¨)</p>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('daily')">ì¼ë³„ ë¦¬í…ì…˜</button>
                    <button class="tab-btn" onclick="switchTab('weekly')">ì£¼ë³„ ë¦¬í…ì…˜</button>
                    <button class="tab-btn" onclick="switchTab('monthly')">ì›”ë³„ ë¦¬í…ì…˜</button>
                </div>

                <div id="daily-tab" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="chart-title" style="margin: 0;">ì¼ë³„ ë¦¬í…ì…˜ ì¶”ì´</h3>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" onclick="switchChartType('daily', 'line')" id="dailyLineBtn" style="padding: 8px 15px; font-size: 13px; background: #ff6b6b; color: white;">
                                ğŸ“ˆ ì„ ê·¸ë˜í”„
                            </button>
                            <button class="btn" onclick="switchChartType('daily', 'bar')" id="dailyBarBtn" style="padding: 8px 15px; font-size: 13px;">
                                ğŸ“Š ë§‰ëŒ€ê·¸ë˜í”„
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>

                <div id="weekly-tab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="chart-title" style="margin: 0;">ì£¼ë³„ ë¦¬í…ì…˜ ì¶”ì´</h3>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" onclick="switchChartType('weekly', 'line')" id="weeklyLineBtn" style="padding: 8px 15px; font-size: 13px;">
                                ğŸ“ˆ ì„ ê·¸ë˜í”„
                            </button>
                            <button class="btn" onclick="switchChartType('weekly', 'bar')" id="weeklyBarBtn" style="padding: 8px 15px; font-size: 13px; background: #ff6b6b; color: white;">
                                ğŸ“Š ë§‰ëŒ€ê·¸ë˜í”„
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <div id="monthly-tab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="chart-title" style="margin: 0;">ì›”ë³„ ë¦¬í…ì…˜ ì¶”ì´</h3>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" onclick="switchChartType('monthly', 'line')" id="monthlyLineBtn" style="padding: 8px 15px; font-size: 13px;">
                                ğŸ“ˆ ì„ ê·¸ë˜í”„
                            </button>
                            <button class="btn" onclick="switchChartType('monthly', 'bar')" id="monthlyBarBtn" style="padding: 8px 15px; font-size: 13px; background: #ff6b6b; color: white;">
                                ğŸ“Š ë§‰ëŒ€ê·¸ë˜í”„
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="chart-title" style="font-size: 24px; margin-bottom: 0;">ğŸ“Š ìƒì„¸ ë°ì´í„°</h2>
                    <button class="btn" id="toggleTableBtn" onclick="toggleTableSection()" style="padding: 8px 16px;">
                        â–¼ í¼ì¹˜ê¸°
                    </button>
                </div>
                <div id="tableContent" class="hidden">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTableTab('daily')">ì¼ë³„</button>
                        <button class="tab-btn" onclick="switchTableTab('weekly')">ì£¼ë³„</button>
                        <button class="tab-btn" onclick="switchTableTab('monthly')">ì›”ë³„</button>
                    </div>
                    <div id="daily-table" class="tab-content active">
                        <table id="dailyTable"></table>
                    </div>
                    <div id="weekly-table" class="tab-content">
                        <table id="weeklyTable"></table>
                    </div>
                    <div id="monthly-table" class="tab-content">
                        <table id="monthlyTable"></table>
                    </div>
                </div>
            </div>

            <div class="chart-section" id="cohort-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="chart-title" style="font-size: 24px; margin-bottom: 0;">ğŸ¯ ì½”í˜¸íŠ¸ ë¦¬í…ì…˜ ë¶„ì„</h2>
                    <button class="btn" id="toggleCohortBtn" onclick="toggleCohortSection()" style="padding: 8px 16px;">
                        â–¼ í¼ì¹˜ê¸°
                    </button>
                </div>
                <div id="cohortContent" class="hidden">
                    <p style="color: #718096; margin-bottom: 10px;">íŠ¹ì • ë‚ ì§œ/ì£¼/ì›”ì— ì²« êµ¬ë§¤í•œ ì‚¬ìš©ì ì§‘ë‹¨ì„ ì¶”ì í•˜ì—¬ ì¬êµ¬ë§¤ìœ¨ ë³€í™”ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
                    <div style="background: #fef5e7; border-left: 4px solid #f39c12; padding: 12px 15px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="color: #7d6608; font-size: 13px; margin: 0;">
                            âš ï¸ <strong>ì£¼ì˜:</strong> ì½”í˜¸íŠ¸ëŠ” <strong>ì—…ë¡œë“œëœ ë°ì´í„° ë²”ìœ„ ë‚´</strong>ì—ì„œ ì²« êµ¬ë§¤ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤. 
                            ì‹¤ì œ ì‹ ê·œ ê³ ê°ì¸ì§€ ê¸°ì¡´ ê³ ê°ì¸ì§€ëŠ” êµ¬ë¶„ë˜ì§€ ì•Šìœ¼ë©°, ë°ì´í„° ì‹œì‘ì¼ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ê¸°ì¡´ ê³ ê°ì´ í¬í•¨ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
                            ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ 3ê°œì›” ì´ìƒì˜ ë°ì´í„° ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchCohortTab('daily')">ì¼ë³„ ì½”í˜¸íŠ¸</button>
                        <button class="tab-btn" onclick="switchCohortTab('weekly')">ì£¼ë³„ ì½”í˜¸íŠ¸</button>
                        <button class="tab-btn" onclick="switchCohortTab('monthly')">ì›”ë³„ ì½”í˜¸íŠ¸</button>
                    </div>

                    <div id="daily-cohort-tab" class="tab-content active">
                        <h3 class="chart-title">ì¼ë³„ ì½”í˜¸íŠ¸ íˆíŠ¸ë§µ</h3>
                        <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
                            ê° ë‚ ì§œì— ì²« êµ¬ë§¤í•œ ì‚¬ìš©ìê°€ D+1, D+2, D+3... ì¼ í›„ì—ë„ êµ¬ë§¤í•˜ëŠ”ì§€ ì¶”ì 
                        </p>
                        <div style="overflow-x: auto;">
                            <table id="dailyCohortTable" class="cohort-table"></table>
                        </div>
                    </div>

                    <div id="weekly-cohort-tab" class="tab-content">
                        <h3 class="chart-title">ì£¼ë³„ ì½”í˜¸íŠ¸ íˆíŠ¸ë§µ</h3>
                        <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
                            ê° ì£¼ì— ì²« êµ¬ë§¤í•œ ì‚¬ìš©ìê°€ W+1, W+2, W+3... ì£¼ í›„ì—ë„ êµ¬ë§¤í•˜ëŠ”ì§€ ì¶”ì 
                        </p>
                        <div style="overflow-x: auto;">
                            <table id="weeklyCohortTable" class="cohort-table"></table>
                        </div>
                    </div>

                    <div id="monthly-cohort-tab" class="tab-content">
                        <h3 class="chart-title">ì›”ë³„ ì½”í˜¸íŠ¸ íˆíŠ¸ë§µ</h3>
                        <p style="color: #718096; font-size: 14px; margin-bottom: 15px;">
                            ê° ì›”ì— ì²« êµ¬ë§¤í•œ ì‚¬ìš©ìê°€ M+1, M+2, M+3... ì›” í›„ì—ë„ êµ¬ë§¤í•˜ëŠ”ì§€ ì¶”ì 
                        </p>
                        <div style="overflow-x: auto;">
                            <table id="monthlyCohortTable" class="cohort-table"></table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="download-section">
                <h3 class="chart-title">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h3>
                <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
                    ğŸ’¡ <strong>JSON íŒŒì¼</strong>ì€ ì›ë³¸ ë°ì´í„°ë¥¼ í¬í•¨í•˜ì—¬, ë‚˜ì¤‘ì— ìƒˆ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ë•Œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <button class="btn btn-primary" onclick="downloadJSON()">
                    ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ (ì›ë³¸ ë°ì´í„° í¬í•¨)
                </button>
                <button class="btn btn-success" onclick="downloadExcel()">
                    ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn btn-secondary" onclick="downloadCSV()">
                    ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn" style="background: #34A853; color: white; margin-top: 15px;" onclick="exportToGoogleSheets()" id="googleSheetsBtn">
                    ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°
                </button>
                <p id="googleSheetsStatus" style="margin-top: 10px; font-size: 13px; color: #4a5568;"></p>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let uploadedJsonFiles = []; // JSON íŒŒì¼ ë°°ì—´ ì¶”ê°€
        let existingData = null;
        let retentionResult = null;
        let originalRetentionResult = null; // í•„í„°ë§ ì „ ì›ë³¸ ë°ì´í„°
        let currentChartTypes = {
            daily: 'line',
            weekly: 'bar',
            monthly: 'bar'
        };

        // Google API ì„¤ì •
        const CLIENT_ID = '111769781876-ts5q219voicb2m7qe1mo7mtpgou7nikh.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDummy'; // API í‚¤ëŠ” í•„ìš” ì—†ìŒ (OAuthë§Œ ì‚¬ìš©)
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // íŒŒì¼ ì—…ë¡œë“œ UI
        const uploadArea = document.getElementById('uploadArea');
        const jsonUploadArea = document.getElementById('jsonUploadArea');
        const fileInput = document.getElementById('fileInput');
        const jsonInput = document.getElementById('jsonInput');
        const fileList = document.getElementById('fileList');
        const jsonFileList = document.getElementById('jsonFileList');
        const calculateBtn = document.getElementById('calculateBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        // JSON ì—…ë¡œë“œ ì˜ì—­ ì´ë²¤íŠ¸
        jsonUploadArea.addEventListener('click', () => jsonInput.click());
        
        jsonUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            jsonUploadArea.classList.add('dragover');
        });

        jsonUploadArea.addEventListener('dragleave', () => {
            jsonUploadArea.classList.remove('dragover');
        });

        jsonUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            jsonUploadArea.classList.remove('dragover');
            
            const newFiles = Array.from(e.dataTransfer.files).filter(f => 
                f.name.endsWith('.json')
            );
            
            // ì¤‘ë³µ ì œê±°
            const existingNames = uploadedJsonFiles.map(f => f.name);
            const uniqueNewFiles = newFiles.filter(f => !existingNames.includes(f.name));
            
            if (uniqueNewFiles.length < newFiles.length) {
                alert(`${newFiles.length - uniqueNewFiles.length}ê°œì˜ ì¤‘ë³µ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            
            uploadedJsonFiles = [...uploadedJsonFiles, ...uniqueNewFiles];
            displayJsonFileList();
            updateCalculateButton();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const newFiles = Array.from(e.dataTransfer.files).filter(f => 
                f.name.endsWith('.xlsx') || f.name.endsWith('.xls')
            );
            
            // ì¤‘ë³µ ì œê±°
            const existingNames = uploadedFiles.map(f => f.name);
            const uniqueNewFiles = newFiles.filter(f => !existingNames.includes(f.name));
            
            if (uniqueNewFiles.length < newFiles.length) {
                alert(`${newFiles.length - uniqueNewFiles.length}ê°œì˜ ì¤‘ë³µ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            
            uploadedFiles = [...uploadedFiles, ...uniqueNewFiles];
            displayFileList();
            updateCalculateButton();
        });

        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files).filter(f => 
                f.name.endsWith('.xlsx') || f.name.endsWith('.xls')
            );
            
            // ì¤‘ë³µ ì œê±° (ê°™ì€ ì´ë¦„ì˜ íŒŒì¼)
            const existingNames = uploadedFiles.map(f => f.name);
            const uniqueNewFiles = newFiles.filter(f => !existingNames.includes(f.name));
            
            if (uniqueNewFiles.length < newFiles.length) {
                alert(`${newFiles.length - uniqueNewFiles.length}ê°œì˜ ì¤‘ë³µ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            
            uploadedFiles = [...uploadedFiles, ...uniqueNewFiles];
            displayFileList();
            updateCalculateButton();
            
            // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            e.target.value = '';
        });

        jsonInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files).filter(f => 
                f.name.endsWith('.json')
            );
            
            // ì¤‘ë³µ ì œê±°
            const existingNames = uploadedJsonFiles.map(f => f.name);
            const uniqueNewFiles = newFiles.filter(f => !existingNames.includes(f.name));
            
            if (uniqueNewFiles.length < newFiles.length) {
                alert(`${newFiles.length - uniqueNewFiles.length}ê°œì˜ ì¤‘ë³µ íŒŒì¼ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            
            uploadedJsonFiles = [...uploadedJsonFiles, ...uniqueNewFiles];
            displayJsonFileList();
            updateCalculateButton();
            
            // input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            e.target.value = '';
        });

        function displayFileList() {
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            const totalSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            fileList.innerHTML = `
                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <strong>ğŸ“‹ ì—…ë¡œë“œëœ íŒŒì¼: ${uploadedFiles.length}ê°œ (${totalSizeMB}MB)</strong>
                    <button class="btn" style="padding: 5px 15px; background: #f56565; color: white; font-size: 12px;" onclick="clearAllFiles()">
                        ğŸ—‘ï¸ ì „ì²´ ì œê±°
                    </button>
                </div>
            ` + uploadedFiles.map((f, i) => {
                const sizeMB = (f.size / 1024 / 1024).toFixed(2);
                return `
                    <div class="file-item">
                        <span>ğŸ“„ ${f.name} <small style="color: #718096;">(${sizeMB}MB)</small></span>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="removeFile(${i})">âŒ ì œê±°</button>
                    </div>
                `;
            }).join('');
        }

        function displayJsonFileList() {
            if (uploadedJsonFiles.length === 0) {
                jsonFileList.innerHTML = '';
                return;
            }
            
            const totalSize = uploadedJsonFiles.reduce((sum, f) => sum + f.size, 0);
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            jsonFileList.innerHTML = `
                <div style="background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <strong>ğŸ“‹ ì—…ë¡œë“œëœ JSON: ${uploadedJsonFiles.length}ê°œ (${totalSizeMB}MB)</strong>
                    <button class="btn" style="padding: 5px 15px; background: #f56565; color: white; font-size: 12px;" onclick="clearAllJsonFiles()">
                        ğŸ—‘ï¸ ì „ì²´ ì œê±°
                    </button>
                </div>
            ` + uploadedJsonFiles.map((f, i) => {
                const sizeMB = (f.size / 1024 / 1024).toFixed(2);
                return `
                    <div class="file-item">
                        <span>ğŸ“‹ ${f.name} <small style="color: #718096;">(${sizeMB}MB)</small></span>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="removeJsonFile(${i})">âŒ ì œê±°</button>
                    </div>
                `;
            }).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFileList();
            updateCalculateButton();
        }
        
        function clearAllFiles() {
            if (confirm(`${uploadedFiles.length}ê°œì˜ íŒŒì¼ì„ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                uploadedFiles = [];
                displayFileList();
                updateCalculateButton();
            }
        }

        function removeJsonFile(index) {
            uploadedJsonFiles.splice(index, 1);
            displayJsonFileList();
            updateCalculateButton();
        }
        
        function clearAllJsonFiles() {
            if (confirm(`${uploadedJsonFiles.length}ê°œì˜ JSON íŒŒì¼ì„ ëª¨ë‘ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                uploadedJsonFiles = [];
                displayJsonFileList();
                updateCalculateButton();
            }
        }

        function updateCalculateButton() {
            // ì—‘ì…€ ë˜ëŠ” JSON ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê³„ì‚° ê°€ëŠ¥
            calculateBtn.disabled = (uploadedFiles.length === 0 && uploadedJsonFiles.length === 0);
        }

        // ë¦¬í…ì…˜ ê³„ì‚°
        calculateBtn.addEventListener('click', async () => {
            document.getElementById('loading').style.display = 'block';
            calculateBtn.disabled = true;

            try {
                const allData = [];
                
                // ì—…ë¡œë“œí•œ JSON íŒŒì¼ë“¤ì˜ ë°ì´í„° ì¶”ê°€
                for (const file of uploadedJsonFiles) {
                    try {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        
                        // raw_transactions í™•ì¸
                        if (!jsonData.raw_transactions) {
                            alert(`âš ï¸ ${file.name}ì€(ëŠ”) êµ¬ë²„ì „ì´ë¼ ì›ë³¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nìƒˆë¡œ ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
                            continue;
                        }
                        
                        console.log(`${file.name}: ${jsonData.raw_transactions.length}ê±´ ë¡œë“œ`);
                        allData.push(...jsonData.raw_transactions);
                    } catch (error) {
                        alert(`âŒ ${file.name} ì½ê¸° ì˜¤ë¥˜: ${error.message}`);
                        continue;
                    }
                }
                
                // ì—‘ì…€ íŒŒì¼ ë°ì´í„° ì¶”ê°€
                for (const file of uploadedFiles) {
                    const data = await readExcelFile(file);
                    allData.push(...data);
                }

                if (allData.length === 0) {
                    alert('âš ï¸ ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    document.getElementById('loading').style.display = 'none';
                    calculateBtn.disabled = false;
                    return;
                }

                console.log(`ì´ ${allData.length}ê±´ ë°ì´í„°ë¡œ ê³„ì‚° ì‹œì‘`);
                retentionResult = calculateRetention(allData);
                
                displayResults(retentionResult);
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('loading').style.display = 'none';
                
                // ìŠ¤í¬ë¡¤ ì´ë™
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                console.error(error);
                document.getElementById('loading').style.display = 'none';
                calculateBtn.disabled = false;
            }
        });

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        resolve(json);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseDate(dateStr) {
            if (dateStr instanceof Date) return dateStr;
            
            // Excel ìˆ«ì ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
            if (typeof dateStr === 'number') {
                const date = new Date((dateStr - 25569) * 86400 * 1000);
                // UTC ë‚ ì§œë¥¼ ë¡œì»¬ ë‚ ì§œë¡œ ì¡°ì •
                return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 
                               date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds());
            }
            
            // ë¬¸ìì—´ ë‚ ì§œ ì²˜ë¦¬ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
            // "2025/07/01 10:30:00" í˜•ì‹
            if (typeof dateStr === 'string') {
                // YYYY/MM/DD HH:mm:ss ë˜ëŠ” YYYY-MM-DD HH:mm:ss í˜•ì‹
                const parts = dateStr.split(/[\s]+/);
                const datePart = parts[0];
                const timePart = parts[1] || '00:00:00';
                
                const dateComponents = datePart.split(/[-/]/);
                const timeComponents = timePart.split(':');
                
                if (dateComponents.length === 3) {
                    const year = parseInt(dateComponents[0]);
                    const month = parseInt(dateComponents[1]) - 1; // 0-based
                    const day = parseInt(dateComponents[2]);
                    const hour = parseInt(timeComponents[0]) || 0;
                    const minute = parseInt(timeComponents[1]) || 0;
                    const second = parseInt(timeComponents[2]) || 0;
                    
                    return new Date(year, month, day, hour, minute, second);
                }
            }
            
            return new Date(dateStr);
        }

        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        // ì£¼ ë²ˆí˜¸ë¥¼ ë‚ ì§œ ë²”ìœ„ í¬í•¨ ë¬¸ìì—´ë¡œ ë³€í™˜
        function formatWeekWithRange(weekStr) {
            // weekStr í˜•ì‹: "2025-W28"
            const [year, weekNum] = weekStr.split('-W');
            const weekNumber = parseInt(weekNum);
            
            // ISO ì£¼ì˜ ì²«ë‚  (ì›”ìš”ì¼) ê³„ì‚°
            const jan4 = new Date(year, 0, 4);
            const daysToMonday = (jan4.getDay() + 6) % 7;
            const firstMonday = new Date(year, 0, 4 - daysToMonday);
            
            // í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (weekNumber - 1) * 7);
            
            // í•´ë‹¹ ì£¼ì˜ ì¼ìš”ì¼
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            // ë‚ ì§œ í¬ë§·íŒ…
            const startMonth = weekStart.getMonth() + 1;
            const startDay = weekStart.getDate();
            const endMonth = weekEnd.getMonth() + 1;
            const endDay = weekEnd.getDate();
            
            return `W${weekNum} (${startMonth}/${startDay}~${endMonth}/${endDay})`;
        }

        function calculateRetention(data) {
            // ì „ì²˜ë¦¬
            const processed = data.map(row => {
                const date = parseDate(row['ì¼ì‹œ']);
                // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (UTC ë³€í™˜ ì•ˆ í•¨!)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                // ì›” ë¬¸ìì—´ë„ ë¡œì»¬ ê¸°ì¤€ìœ¼ë¡œ
                const monthStr = `${year}-${month}`;
                
                return {
                    buyer: row['êµ¬ë§¤ì'],
                    date: date,
                    dateStr: dateStr,
                    month: monthStr,
                    week: getISOWeek(date)
                };
            });

            // ì¼ë³„ êµ¬ë§¤ì
            const dailyBuyers = {};
            processed.forEach(row => {
                if (!dailyBuyers[row.dateStr]) {
                    dailyBuyers[row.dateStr] = new Set();
                }
                dailyBuyers[row.dateStr].add(row.buyer);
            });

            // ì£¼ë³„ êµ¬ë§¤ì
            const weeklyBuyers = {};
            processed.forEach(row => {
                if (!weeklyBuyers[row.week]) {
                    weeklyBuyers[row.week] = new Set();
                }
                weeklyBuyers[row.week].add(row.buyer);
            });

            // ì›”ë³„ êµ¬ë§¤ì
            const monthlyBuyers = {};
            processed.forEach(row => {
                if (!monthlyBuyers[row.month]) {
                    monthlyBuyers[row.month] = new Set();
                }
                monthlyBuyers[row.month].add(row.buyer);
            });

            // ì¼ë³„ ë¦¬í…ì…˜
            const dailyDates = Object.keys(dailyBuyers).sort();
            const dailyRetention = [];
            for (let i = 1; i < dailyDates.length; i++) {
                const prevDate = dailyDates[i - 1];
                const currDate = dailyDates[i];
                const prevUsers = dailyBuyers[prevDate];
                const currUsers = dailyBuyers[currDate];
                const retained = [...prevUsers].filter(u => currUsers.has(u)).length;
                const rate = prevUsers.size > 0 ? (retained / prevUsers.size * 100) : 0;

                dailyRetention.push({
                    ê¸°ì¤€ì¼: prevDate,
                    ë¹„êµì¼: currDate,
                    ê¸°ì¤€ì¼_êµ¬ë§¤ììˆ˜: prevUsers.size,
                    ì¬êµ¬ë§¤ììˆ˜: retained,
                    ë¦¬í…ì…˜ìœ¨: parseFloat(rate.toFixed(2))
                });
            }

            // ì£¼ë³„ ë¦¬í…ì…˜
            const weeks = Object.keys(weeklyBuyers).sort();
            
            // ê° ì£¼ì˜ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
            const weekDateRanges = {};
            processed.forEach(row => {
                if (!weekDateRanges[row.week]) {
                    weekDateRanges[row.week] = {
                        minDate: row.dateStr,
                        maxDate: row.dateStr
                    };
                } else {
                    if (row.dateStr < weekDateRanges[row.week].minDate) {
                        weekDateRanges[row.week].minDate = row.dateStr;
                    }
                    if (row.dateStr > weekDateRanges[row.week].maxDate) {
                        weekDateRanges[row.week].maxDate = row.dateStr;
                    }
                }
            });
            
            const weeklyRetention = [];
            for (let i = 1; i < weeks.length; i++) {
                const prevWeek = weeks[i - 1];
                const currWeek = weeks[i];
                const prevUsers = weeklyBuyers[prevWeek];
                const currUsers = weeklyBuyers[currWeek];
                const retained = [...prevUsers].filter(u => currUsers.has(u)).length;
                const rate = prevUsers.size > 0 ? (retained / prevUsers.size * 100) : 0;

                weeklyRetention.push({
                    ê¸°ì¤€ì£¼: prevWeek,
                    ê¸°ì¤€ì£¼_ê¸°ê°„: `${weekDateRanges[prevWeek].minDate} ~ ${weekDateRanges[prevWeek].maxDate}`,
                    ë¹„êµì£¼: currWeek,
                    ë¹„êµì£¼_ê¸°ê°„: `${weekDateRanges[currWeek].minDate} ~ ${weekDateRanges[currWeek].maxDate}`,
                    ê¸°ì¤€ì£¼_êµ¬ë§¤ììˆ˜: prevUsers.size,
                    ì¬êµ¬ë§¤ììˆ˜: retained,
                    ë¦¬í…ì…˜ìœ¨: parseFloat(rate.toFixed(2))
                });
            }

            // ì›”ë³„ ë¦¬í…ì…˜
            const months = Object.keys(monthlyBuyers).sort();
            const monthlyRetention = [];
            for (let i = 1; i < months.length; i++) {
                const prevMonth = months[i - 1];
                const currMonth = months[i];
                const prevUsers = monthlyBuyers[prevMonth];
                const currUsers = monthlyBuyers[currMonth];
                const retained = [...prevUsers].filter(u => currUsers.has(u)).length;
                const rate = prevUsers.size > 0 ? (retained / prevUsers.size * 100) : 0;

                monthlyRetention.push({
                    ê¸°ì¤€ì›”: prevMonth,
                    ë¹„êµì›”: currMonth,
                    ê¸°ì¤€ì›”_êµ¬ë§¤ììˆ˜: prevUsers.size,
                    ì¬êµ¬ë§¤ììˆ˜: retained,
                    ë¦¬í…ì…˜ìœ¨: parseFloat(rate.toFixed(2))
                });
            }

            const allBuyers = new Set(processed.map(p => p.buyer));
            
            // ì½”í˜¸íŠ¸ ë¶„ì„ ì¶”ê°€
            const cohortAnalysis = calculateCohortRetention(processed);
            
            return {
                metadata: {
                    generated_at: new Date().toISOString(),
                    data_period: `${dailyDates[0]} ~ ${dailyDates[dailyDates.length - 1]}`,
                    total_records: data.length,
                    unique_buyers: allBuyers.size
                },
                daily_retention: dailyRetention,
                weekly_retention: weeklyRetention,
                monthly_retention: monthlyRetention,
                cohort_analysis: cohortAnalysis,
                raw_transactions: data  // ì›ë³¸ ê±°ë˜ ë°ì´í„° ì €ì¥ (JSON ì¬ì‚¬ìš©ìš©)
            };
        }

        function calculateCohortRetention(processed) {
            // ê° êµ¬ë§¤ìì˜ ì²« êµ¬ë§¤ì¼ ì°¾ê¸°
            const firstPurchase = {};
            processed.forEach(row => {
                if (!firstPurchase[row.buyer]) {
                    firstPurchase[row.buyer] = {
                        date: row.dateStr,
                        week: row.week,
                        month: row.month
                    };
                } else {
                    if (row.dateStr < firstPurchase[row.buyer].date) {
                        firstPurchase[row.buyer] = {
                            date: row.dateStr,
                            week: row.week,
                            month: row.month
                        };
                    }
                }
            });

            // ì¼ë³„ ì½”í˜¸íŠ¸
            const dailyCohorts = {};
            const allDates = [...new Set(processed.map(p => p.dateStr))].sort();
            
            allDates.forEach(cohortDate => {
                const cohortUsers = Object.keys(firstPurchase).filter(
                    buyer => firstPurchase[buyer].date === cohortDate
                );
                
                if (cohortUsers.length === 0) return;
                
                dailyCohorts[cohortDate] = {
                    cohort_size: cohortUsers.length,
                    retention: {}
                };
                
                // D+1ë¶€í„° D+30ê¹Œì§€ ê³„ì‚°
                const cohortDateObj = new Date(cohortDate);
                for (let days of [1, 2, 3, 7, 14, 30]) {
                    const targetDate = new Date(cohortDateObj);
                    targetDate.setDate(targetDate.getDate() + days);
                    // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    const year = targetDate.getFullYear();
                    const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                    const day = String(targetDate.getDate()).padStart(2, '0');
                    const targetDateStr = `${year}-${month}-${day}`;
                    
                    const targetUsers = new Set(
                        processed.filter(p => p.dateStr === targetDateStr).map(p => p.buyer)
                    );
                    
                    const retained = cohortUsers.filter(buyer => targetUsers.has(buyer)).length;
                    const rate = (retained / cohortUsers.length * 100);
                    dailyCohorts[cohortDate].retention[`D+${days}`] = parseFloat(rate.toFixed(2));
                }
            });

            // ì£¼ë³„ ì½”í˜¸íŠ¸
            const weeklyCohorts = {};
            const allWeeks = [...new Set(processed.map(p => p.week))].sort();
            
            allWeeks.forEach(cohortWeek => {
                const cohortUsers = Object.keys(firstPurchase).filter(
                    buyer => firstPurchase[buyer].week === cohortWeek
                );
                
                if (cohortUsers.length === 0) return;
                
                weeklyCohorts[cohortWeek] = {
                    cohort_size: cohortUsers.length,
                    retention: {}
                };
                
                const cohortIdx = allWeeks.indexOf(cohortWeek);
                for (let offset of [1, 2, 3, 4]) {
                    if (cohortIdx + offset < allWeeks.length) {
                        const targetWeek = allWeeks[cohortIdx + offset];
                        const targetUsers = new Set(
                            processed.filter(p => p.week === targetWeek).map(p => p.buyer)
                        );
                        
                        const retained = cohortUsers.filter(buyer => targetUsers.has(buyer)).length;
                        const rate = (retained / cohortUsers.length * 100);
                        weeklyCohorts[cohortWeek].retention[`W+${offset}`] = parseFloat(rate.toFixed(2));
                    }
                }
            });

            // ì›”ë³„ ì½”í˜¸íŠ¸
            const monthlyCohorts = {};
            const allMonths = [...new Set(processed.map(p => p.month))].sort();
            
            allMonths.forEach(cohortMonth => {
                const cohortUsers = Object.keys(firstPurchase).filter(
                    buyer => firstPurchase[buyer].month === cohortMonth
                );
                
                if (cohortUsers.length === 0) return;
                
                monthlyCohorts[cohortMonth] = {
                    cohort_size: cohortUsers.length,
                    retention: {}
                };
                
                const cohortIdx = allMonths.indexOf(cohortMonth);
                for (let offset of [1, 2, 3]) {
                    if (cohortIdx + offset < allMonths.length) {
                        const targetMonth = allMonths[cohortIdx + offset];
                        const targetUsers = new Set(
                            processed.filter(p => p.month === targetMonth).map(p => p.buyer)
                        );
                        
                        const retained = cohortUsers.filter(buyer => targetUsers.has(buyer)).length;
                        const rate = (retained / cohortUsers.length * 100);
                        monthlyCohorts[cohortMonth].retention[`M+${offset}`] = parseFloat(rate.toFixed(2));
                    }
                }
            });

            return {
                daily: dailyCohorts,
                weekly: weeklyCohorts,
                monthly: monthlyCohorts
            };
        }

        let dailyChart, weeklyChart, monthlyChart;

        function displayResults(result, isInitialLoad = true) {
            // ì´ˆê¸° ë¡œë“œì‹œì—ë§Œ ì›ë³¸ ë°ì´í„° ì €ì¥ ë° ë‚ ì§œ ë²”ìœ„ ì„¤ì •
            if (isInitialLoad) {
                originalRetentionResult = JSON.parse(JSON.stringify(result));
                
                // ë‚ ì§œ í•„í„° ë²”ìœ„ë¥¼ ì „ì²´ ë°ì´í„° ê¸°ê°„ìœ¼ë¡œ ì„¤ì •
                if (result.metadata && result.metadata.data_period) {
                    const period = result.metadata.data_period.split(' ~ ');
                    document.getElementById('filterStartDate').value = period[0];
                    document.getElementById('filterEndDate').value = period[1];
                    document.getElementById('filterStatus').textContent = `ğŸ“… ì „ì²´ ë°ì´í„° ê¸°ê°„: ${result.metadata.data_period}`;
                }
            }
            
            // í†µê³„ ì¹´ë“œ
            document.getElementById('dataPeriod').textContent = result.metadata.data_period;
            document.getElementById('totalRecords').textContent = result.metadata.total_records.toLocaleString();
            document.getElementById('uniqueBuyers').textContent = result.metadata.unique_buyers.toLocaleString();
            
            const avgRetention = (
                result.daily_retention.reduce((sum, r) => sum + r.ë¦¬í…ì…˜ìœ¨, 0) / result.daily_retention.length
            ).toFixed(2);
            document.getElementById('avgRetention').textContent = avgRetention;

            // ì°¨íŠ¸
            createDailyChart(result.daily_retention, currentChartTypes.daily);
            createWeeklyChart(result.weekly_retention, currentChartTypes.weekly);
            createMonthlyChart(result.monthly_retention, currentChartTypes.monthly);

            // í…Œì´ë¸”
            createTable('dailyTable', result.daily_retention, ['ê¸°ì¤€ì¼', 'ë¹„êµì¼', 'ê¸°ì¤€ì¼_êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨']);
            createTable('weeklyTable', result.weekly_retention, ['ê¸°ì¤€ì£¼', 'ê¸°ì¤€ì£¼_ê¸°ê°„', 'ë¹„êµì£¼', 'ë¹„êµì£¼_ê¸°ê°„', 'ê¸°ì¤€ì£¼_êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨']);
            createTable('monthlyTable', result.monthly_retention, ['ê¸°ì¤€ì›”', 'ë¹„êµì›”', 'ê¸°ì¤€ì›”_êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨']);

            // ì½”í˜¸íŠ¸ íˆíŠ¸ë§µ
            if (result.cohort_analysis) {
                createCohortHeatmap('dailyCohortTable', result.cohort_analysis.daily, ['D+1', 'D+2', 'D+3', 'D+7', 'D+14', 'D+30']);
                createCohortHeatmap('weeklyCohortTable', result.cohort_analysis.weekly, ['W+1', 'W+2', 'W+3', 'W+4']);
                createCohortHeatmap('monthlyCohortTable', result.cohort_analysis.monthly, null); // ìë™ìœ¼ë¡œ ì „ì²´ ë²”ìœ„ ê³„ì‚°
            }
            
            // ì°¨íŠ¸ íƒ€ì… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateChartTypeButtons();
        }

        function createDailyChart(data, chartType = 'line') {
            const ctx = document.getElementById('dailyChart');
            if (dailyChart) dailyChart.destroy();

            const config = {
                type: chartType,
                data: {
                    labels: data.map(d => d.ë¹„êµì¼),
                    datasets: [{
                        label: 'ë¦¬í…ì…˜ìœ¨ (%)',
                        data: data.map(d => d.ë¦¬í…ì…˜ìœ¨),
                        borderColor: '#ff6b6b',
                        backgroundColor: chartType === 'line' ? 'rgba(255, 107, 107, 0.1)' : '#ff6b6b',
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            };

            dailyChart = new Chart(ctx, config);
        }

        function createWeeklyChart(data, chartType = 'bar') {
            const ctx = document.getElementById('weeklyChart');
            if (weeklyChart) weeklyChart.destroy();

            const config = {
                type: chartType,
                data: {
                    labels: data.map(d => formatWeekWithRange(d.ë¹„êµì£¼)),
                    datasets: [{
                        label: 'ë¦¬í…ì…˜ìœ¨ (%)',
                        data: data.map(d => d.ë¦¬í…ì…˜ìœ¨),
                        borderColor: '#ff8787',
                        backgroundColor: chartType === 'line' ? 'rgba(255, 135, 135, 0.1)' : '#ff8787',
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            };

            weeklyChart = new Chart(ctx, config);
        }

        function createMonthlyChart(data, chartType = 'bar') {
            const ctx = document.getElementById('monthlyChart');
            if (monthlyChart) monthlyChart.destroy();

            const config = {
                type: chartType,
                data: {
                    labels: data.map(d => d.ë¹„êµì›”),
                    datasets: [{
                        label: 'ë¦¬í…ì…˜ìœ¨ (%)',
                        data: data.map(d => d.ë¦¬í…ì…˜ìœ¨),
                        borderColor: '#ff6b81',
                        backgroundColor: chartType === 'line' ? 'rgba(255, 107, 129, 0.1)' : '#ff6b81',
                        tension: 0.4,
                        fill: chartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            };

            monthlyChart = new Chart(ctx, config);
        }

        function createTable(tableId, data, columns) {
            const table = document.getElementById(tableId);
            
            const headerLabels = {
                'ê¸°ì¤€ì¼': 'ê¸°ì¤€ì¼',
                'ë¹„êµì¼': 'ë¹„êµì¼',
                'ê¸°ì¤€ì£¼': 'ê¸°ì¤€ì£¼',
                'ê¸°ì¤€ì£¼_ê¸°ê°„': 'ê¸°ê°„',
                'ë¹„êµì£¼': 'ë¹„êµì£¼',
                'ë¹„êµì£¼_ê¸°ê°„': 'ê¸°ê°„',
                'ê¸°ì¤€ì›”': 'ê¸°ì¤€ì›”',
                'ë¹„êµì›”': 'ë¹„êµì›”',
                'ê¸°ì¤€ì¼_êµ¬ë§¤ììˆ˜': 'ê¸°ì¤€ êµ¬ë§¤ì',
                'ê¸°ì¤€ì£¼_êµ¬ë§¤ììˆ˜': 'ê¸°ì¤€ êµ¬ë§¤ì',
                'ê¸°ì¤€ì›”_êµ¬ë§¤ììˆ˜': 'ê¸°ì¤€ êµ¬ë§¤ì',
                'ì¬êµ¬ë§¤ììˆ˜': 'ì¬êµ¬ë§¤ì',
                'ë¦¬í…ì…˜ìœ¨': 'ë¦¬í…ì…˜ìœ¨'
            };

            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${headerLabels[col]}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    let className = '';
                    
                    if (col === 'ë¦¬í…ì…˜ìœ¨') {
                        className = value >= 10 ? 'retention-high' : value >= 5 ? 'retention-medium' : 'retention-low';
                        value = value + '%';
                    } else if (col.includes('êµ¬ë§¤ììˆ˜')) {
                        value = value.toLocaleString() + 'ëª…';
                    } else if ((col === 'ê¸°ì¤€ì£¼' || col === 'ë¹„êµì£¼') && value && value.includes('-W')) {
                        // ì£¼ë³„ ë°ì´í„°ì¼ ë•Œ ë‚ ì§œ ë²”ìœ„ í¬í•¨
                        value = formatWeekWithRange(value);
                    }
                    
                    html += `<td class="${className}">${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.chart-section .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        function switchTableTab(tab) {
            const parent = event.target.parentElement;
            parent.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.table-section .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-table`).classList.add('active');
        }

        function toggleInfo() {
            const content = document.getElementById('infoContent');
            const toggle = document.getElementById('infoToggle');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = 'â–²';
            } else {
                content.classList.add('hidden');
                toggle.textContent = 'â–¼';
            }
        }

        function toggleTableSection() {
            const content = document.getElementById('tableContent');
            const btn = document.getElementById('toggleTableBtn');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = 'â–² ì ‘ê¸°';
            } else {
                content.classList.add('hidden');
                btn.textContent = 'â–¼ í¼ì¹˜ê¸°';
            }
        }

        function toggleCohortSection() {
            const content = document.getElementById('cohortContent');
            const btn = document.getElementById('toggleCohortBtn');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = 'â–² ì ‘ê¸°';
            } else {
                content.classList.add('hidden');
                btn.textContent = 'â–¼ í¼ì¹˜ê¸°';
            }
        }

        function switchCohortTab(tab) {
            const parent = event.target.parentElement;
            parent.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ì½”í˜¸íŠ¸ ì„¹ì…˜ ë‚´ì˜ ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¹€
            document.querySelectorAll('#cohort-section .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒí•œ íƒ­ë§Œ í‘œì‹œ
            document.getElementById(`${tab}-cohort-tab`).classList.add('active');
        }

        function createCohortHeatmap(tableId, cohortData, periods) {
            const table = document.getElementById(tableId);
            
            // periodsê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ ë°ì´í„°ì—ì„œ ìë™ìœ¼ë¡œ ê³„ì‚°
            if (!periods || periods.length === 0) {
                const allPeriods = new Set();
                Object.values(cohortData).forEach(data => {
                    Object.keys(data.retention || {}).forEach(period => {
                        allPeriods.add(period);
                    });
                });
                
                // ê¸°ê°„ì„ ìˆ«ì ìˆœì„œëŒ€ë¡œ ì •ë ¬ (M+1, M+2, ... M+10)
                periods = Array.from(allPeriods).sort((a, b) => {
                    const numA = parseInt(a.match(/\d+/)[0]);
                    const numB = parseInt(b.match(/\d+/)[0]);
                    return numA - numB;
                });
            }
            
            // í—¤ë” ìƒì„±
            let html = '<thead><tr><th>ì½”í˜¸íŠ¸</th><th>ì¸ì›</th>';
            periods.forEach(period => {
                html += `<th>${period}</th>`;
            });
            html += '</tr></thead><tbody>';

            // ì½”í˜¸íŠ¸ ë°ì´í„° ì •ë ¬ (ì˜¤ë˜ëœ ìˆœì„œë¡œ)
            // ëª¨ë“  ì½”í˜¸íŠ¸ ì „ì²´ í‘œì‹œ (ì œí•œ ì—†ìŒ)
            const cohortKeys = Object.keys(cohortData).sort();

            cohortKeys.forEach(cohort => {
                const data = cohortData[cohort];
                html += '<tr>';
                
                // ì£¼ë³„ ì½”í˜¸íŠ¸ëŠ” ë‚ ì§œ ë²”ìœ„ í¬í•¨ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                const displayCohort = cohort.includes('-W') ? formatWeekWithRange(cohort) : cohort;
                html += `<td><strong>${displayCohort}</strong></td>`;
                html += `<td>${data.cohort_size.toLocaleString()}ëª…</td>`;
                
                periods.forEach(period => {
                    const rate = data.retention[period] || 0;
                    let className = 'cohort-low';
                    if (rate >= 5) className = 'cohort-high';
                    else if (rate >= 2) className = 'cohort-medium';
                    
                    html += `<td class="cohort-cell ${className}">${rate.toFixed(2)}%</td>`;
                });
                
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // ì°¨íŠ¸ íƒ€ì… ì „í™˜ í•¨ìˆ˜
        function switchChartType(period, type) {
            currentChartTypes[period] = type;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateChartTypeButtons();
            
            // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            if (period === 'daily') {
                createDailyChart(retentionResult.daily_retention, type);
            } else if (period === 'weekly') {
                createWeeklyChart(retentionResult.weekly_retention, type);
            } else if (period === 'monthly') {
                createMonthlyChart(retentionResult.monthly_retention, type);
            }
        }

        // ì°¨íŠ¸ íƒ€ì… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateChartTypeButtons() {
            // ì¼ë³„
            const dailyLineBtn = document.getElementById('dailyLineBtn');
            const dailyBarBtn = document.getElementById('dailyBarBtn');
            if (currentChartTypes.daily === 'line') {
                dailyLineBtn.style.background = '#ff6b6b';
                dailyLineBtn.style.color = 'white';
                dailyBarBtn.style.background = '';
                dailyBarBtn.style.color = '';
            } else {
                dailyLineBtn.style.background = '';
                dailyLineBtn.style.color = '';
                dailyBarBtn.style.background = '#ff6b6b';
                dailyBarBtn.style.color = 'white';
            }
            
            // ì£¼ë³„
            const weeklyLineBtn = document.getElementById('weeklyLineBtn');
            const weeklyBarBtn = document.getElementById('weeklyBarBtn');
            if (currentChartTypes.weekly === 'line') {
                weeklyLineBtn.style.background = '#ff6b6b';
                weeklyLineBtn.style.color = 'white';
                weeklyBarBtn.style.background = '';
                weeklyBarBtn.style.color = '';
            } else {
                weeklyLineBtn.style.background = '';
                weeklyLineBtn.style.color = '';
                weeklyBarBtn.style.background = '#ff6b6b';
                weeklyBarBtn.style.color = 'white';
            }
            
            // ì›”ë³„
            const monthlyLineBtn = document.getElementById('monthlyLineBtn');
            const monthlyBarBtn = document.getElementById('monthlyBarBtn');
            if (currentChartTypes.monthly === 'line') {
                monthlyLineBtn.style.background = '#ff6b6b';
                monthlyLineBtn.style.color = 'white';
                monthlyBarBtn.style.background = '';
                monthlyBarBtn.style.color = '';
            } else {
                monthlyLineBtn.style.background = '';
                monthlyLineBtn.style.color = '';
                monthlyBarBtn.style.background = '#ff6b6b';
                monthlyBarBtn.style.color = 'white';
            }
        }

        // ë‚ ì§œ í•„í„° ì ìš©
        function applyDateFilter() {
            if (!originalRetentionResult) {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (startDate > endDate) {
                alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì›ë³¸ ë°ì´í„°ì—ì„œ í•„í„°ë§
            const filteredResult = filterRetentionData(originalRetentionResult, startDate, endDate);
            
            if (filteredResult.daily_retention.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            retentionResult = filteredResult;
            displayResults(filteredResult, false); // í•„í„° ì ìš©ì´ë¯€ë¡œ isInitialLoad=false
            document.getElementById('filterStatus').textContent = `ğŸ” í•„í„° ì ìš©ë¨: ${startDate} ~ ${endDate}`;
        }

        // ë‚ ì§œ í•„í„° ì´ˆê¸°í™”
        function resetDateFilter() {
            if (!originalRetentionResult) {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì›
            retentionResult = JSON.parse(JSON.stringify(originalRetentionResult));
            
            // ë‚ ì§œ inputì„ ì›ë³¸ ì „ì²´ ê¸°ê°„ìœ¼ë¡œ ì¬ì„¤ì •
            if (originalRetentionResult.metadata && originalRetentionResult.metadata.data_period) {
                const period = originalRetentionResult.metadata.data_period.split(' ~ ');
                document.getElementById('filterStartDate').value = period[0];
                document.getElementById('filterEndDate').value = period[1];
            }
            
            displayResults(retentionResult, false); // ì´ˆê¸°í™”ì´ë¯€ë¡œ isInitialLoad=false
            document.getElementById('filterStatus').textContent = `ğŸ“… ì „ì²´ ë°ì´í„° ê¸°ê°„: ${originalRetentionResult.metadata.data_period}`;
        }

        // ë°ì´í„° í•„í„°ë§ ë¡œì§
        function filterRetentionData(originalData, startDate, endDate) {
            const filtered = JSON.parse(JSON.stringify(originalData));
            
            // ì¼ë³„ ë¦¬í…ì…˜ í•„í„°ë§
            filtered.daily_retention = originalData.daily_retention.filter(row => {
                return row.ê¸°ì¤€ì¼ >= startDate && row.ë¹„êµì¼ <= endDate;
            });
            
            // ì£¼ë³„ ë¦¬í…ì…˜ í•„í„°ë§ (ê¸°ì¤€ì£¼ì˜ ì‹œì‘ì¼ê³¼ ë¹„êµì£¼ì˜ ì¢…ë£Œì¼ í™•ì¸)
            filtered.weekly_retention = originalData.weekly_retention.filter(row => {
                const ê¸°ì¤€ì£¼ê¸°ê°„ = row.ê¸°ì¤€ì£¼_ê¸°ê°„.split(' ~ ');
                const ë¹„êµì£¼ê¸°ê°„ = row.ë¹„êµì£¼_ê¸°ê°„.split(' ~ ');
                return ê¸°ì¤€ì£¼ê¸°ê°„[0] >= startDate && ë¹„êµì£¼ê¸°ê°„[1] <= endDate;
            });
            
            // ì›”ë³„ ë¦¬í…ì…˜ í•„í„°ë§
            filtered.monthly_retention = originalData.monthly_retention.filter(row => {
                // YYYY-MM í˜•ì‹ì„ YYYY-MM-01ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                const ê¸°ì¤€ì›”Start = row.ê¸°ì¤€ì›” + '-01';
                const ë¹„êµì›”Start = row.ë¹„êµì›” + '-01';
                return ê¸°ì¤€ì›”Start >= startDate.substring(0, 7) + '-01' && ë¹„êµì›”Start <= endDate.substring(0, 7) + '-01';
            });
            
            // ì½”í˜¸íŠ¸ ë¶„ì„ í•„í„°ë§
            if (filtered.cohort_analysis) {
                // ì¼ë³„ ì½”í˜¸íŠ¸
                const filteredDailyCohorts = {};
                Object.keys(originalData.cohort_analysis.daily).forEach(cohortDate => {
                    if (cohortDate >= startDate && cohortDate <= endDate) {
                        filteredDailyCohorts[cohortDate] = originalData.cohort_analysis.daily[cohortDate];
                    }
                });
                filtered.cohort_analysis.daily = filteredDailyCohorts;
                
                // ì£¼ë³„ ì½”í˜¸íŠ¸
                const filteredWeeklyCohorts = {};
                Object.keys(originalData.cohort_analysis.weekly).forEach(cohortWeek => {
                    const weekRange = formatWeekWithRange(cohortWeek);
                    const weekDates = weekRange.match(/\d{2}\/\d{2}/g);
                    if (weekDates && weekDates.length >= 2) {
                        const year = cohortWeek.split('-')[0];
                        const weekStart = `${year}-${weekDates[0].replace('/', '-')}`;
                        if (weekStart >= startDate && weekStart <= endDate) {
                            filteredWeeklyCohorts[cohortWeek] = originalData.cohort_analysis.weekly[cohortWeek];
                        }
                    }
                });
                filtered.cohort_analysis.weekly = filteredWeeklyCohorts;
                
                // ì›”ë³„ ì½”í˜¸íŠ¸
                const filteredMonthlyCohorts = {};
                Object.keys(originalData.cohort_analysis.monthly).forEach(cohortMonth => {
                    const monthStart = cohortMonth + '-01';
                    if (monthStart >= startDate.substring(0, 7) + '-01' && monthStart <= endDate.substring(0, 7) + '-01') {
                        filteredMonthlyCohorts[cohortMonth] = originalData.cohort_analysis.monthly[cohortMonth];
                    }
                });
                filtered.cohort_analysis.monthly = filteredMonthlyCohorts;
            }
            
            // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
            filtered.metadata.data_period = `${startDate} ~ ${endDate}`;
            
            return filtered;
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(retentionResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'retention_result.json';
            a.click();
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();

            // ì¼ë³„ ì‹œíŠ¸
            const dailyWs = XLSX.utils.json_to_sheet(retentionResult.daily_retention);
            XLSX.utils.book_append_sheet(wb, dailyWs, 'ì¼ë³„_ë¦¬í…ì…˜');

            // ì£¼ë³„ ì‹œíŠ¸
            const weeklyWs = XLSX.utils.json_to_sheet(retentionResult.weekly_retention);
            XLSX.utils.book_append_sheet(wb, weeklyWs, 'ì£¼ë³„_ë¦¬í…ì…˜');

            // ì›”ë³„ ì‹œíŠ¸
            const monthlyWs = XLSX.utils.json_to_sheet(retentionResult.monthly_retention);
            XLSX.utils.book_append_sheet(wb, monthlyWs, 'ì›”ë³„_ë¦¬í…ì…˜');

            // ì½”í˜¸íŠ¸ ì‹œíŠ¸ë“¤
            if (retentionResult.cohort_analysis) {
                // ì¼ë³„ ì½”í˜¸íŠ¸
                const dailyCohortData = Object.keys(retentionResult.cohort_analysis.daily).map(cohort => {
                    const data = retentionResult.cohort_analysis.daily[cohort];
                    return {
                        'ì½”í˜¸íŠ¸': cohort,
                        'ì¸ì›': data.cohort_size,
                        ...data.retention
                    };
                });
                const dailyCohortWs = XLSX.utils.json_to_sheet(dailyCohortData);
                XLSX.utils.book_append_sheet(wb, dailyCohortWs, 'ì¼ë³„_ì½”í˜¸íŠ¸');

                // ì£¼ë³„ ì½”í˜¸íŠ¸
                const weeklyCohortData = Object.keys(retentionResult.cohort_analysis.weekly).map(cohort => {
                    const data = retentionResult.cohort_analysis.weekly[cohort];
                    return {
                        'ì½”í˜¸íŠ¸': cohort,
                        'ì¸ì›': data.cohort_size,
                        ...data.retention
                    };
                });
                const weeklyCohortWs = XLSX.utils.json_to_sheet(weeklyCohortData);
                XLSX.utils.book_append_sheet(wb, weeklyCohortWs, 'ì£¼ë³„_ì½”í˜¸íŠ¸');

                // ì›”ë³„ ì½”í˜¸íŠ¸
                const monthlyCohortData = Object.keys(retentionResult.cohort_analysis.monthly).map(cohort => {
                    const data = retentionResult.cohort_analysis.monthly[cohort];
                    return {
                        'ì½”í˜¸íŠ¸': cohort,
                        'ì¸ì›': data.cohort_size,
                        ...data.retention
                    };
                });
                const monthlyCohortWs = XLSX.utils.json_to_sheet(monthlyCohortData);
                XLSX.utils.book_append_sheet(wb, monthlyCohortWs, 'ì›”ë³„_ì½”í˜¸íŠ¸');
            }

            // ìš”ì•½ ì‹œíŠ¸
            const summary = [
                { í•­ëª©: 'ë°ì´í„° ê¸°ê°„', ê°’: retentionResult.metadata.data_period },
                { í•­ëª©: 'ì´ ê±°ë˜ ê±´ìˆ˜', ê°’: retentionResult.metadata.total_records },
                { í•­ëª©: 'ìœ ë‹ˆí¬ êµ¬ë§¤ì', ê°’: retentionResult.metadata.unique_buyers },
                { í•­ëª©: 'ì¼ë³„ í‰ê·  ë¦¬í…ì…˜', ê°’: (retentionResult.daily_retention.reduce((s, r) => s + r.ë¦¬í…ì…˜ìœ¨, 0) / retentionResult.daily_retention.length).toFixed(2) + '%' }
            ];
            const summaryWs = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'ìš”ì•½');

            XLSX.writeFile(wb, 'retention_report.xlsx');
        }

        function downloadCSV() {
            let csv = 'êµ¬ë¶„,ê¸°ì¤€,ë¹„êµ,ê¸°ì¤€_êµ¬ë§¤ììˆ˜,ì¬êµ¬ë§¤ììˆ˜,ë¦¬í…ì…˜ìœ¨\n';
            
            retentionResult.daily_retention.forEach(row => {
                csv += `ì¼ë³„,${row.ê¸°ì¤€ì¼},${row.ë¹„êµì¼},${row.ê¸°ì¤€ì¼_êµ¬ë§¤ììˆ˜},${row.ì¬êµ¬ë§¤ììˆ˜},${row.ë¦¬í…ì…˜ìœ¨}\n`;
            });

            retentionResult.weekly_retention.forEach(row => {
                csv += `ì£¼ë³„,${row.ê¸°ì¤€ì£¼},${row.ë¹„êµì£¼},${row.ê¸°ì¤€ì£¼_êµ¬ë§¤ììˆ˜},${row.ì¬êµ¬ë§¤ììˆ˜},${row.ë¦¬í…ì…˜ìœ¨}\n`;
            });

            retentionResult.monthly_retention.forEach(row => {
                csv += `ì›”ë³„,${row.ê¸°ì¤€ì›”},${row.ë¹„êµì›”},${row.ê¸°ì¤€ì›”_êµ¬ë§¤ììˆ˜},${row.ì¬êµ¬ë§¤ììˆ˜},${row.ë¦¬í…ì…˜ìœ¨}\n`;
            });

            // ì½”í˜¸íŠ¸ ë°ì´í„° ì¶”ê°€
            if (retentionResult.cohort_analysis) {
                csv += '\nì½”í˜¸íŠ¸_êµ¬ë¶„,ì½”í˜¸íŠ¸,ì¸ì›,ê¸°ê°„,ë¦¬í…ì…˜ìœ¨\n';
                
                // ì¼ë³„ ì½”í˜¸íŠ¸
                Object.keys(retentionResult.cohort_analysis.daily).forEach(cohort => {
                    const data = retentionResult.cohort_analysis.daily[cohort];
                    Object.keys(data.retention).forEach(period => {
                        csv += `ì¼ë³„_ì½”í˜¸íŠ¸,${cohort},${data.cohort_size},${period},${data.retention[period]}\n`;
                    });
                });

                // ì£¼ë³„ ì½”í˜¸íŠ¸
                Object.keys(retentionResult.cohort_analysis.weekly).forEach(cohort => {
                    const data = retentionResult.cohort_analysis.weekly[cohort];
                    Object.keys(data.retention).forEach(period => {
                        csv += `ì£¼ë³„_ì½”í˜¸íŠ¸,${cohort},${data.cohort_size},${period},${data.retention[period]}\n`;
                    });
                });

                // ì›”ë³„ ì½”í˜¸íŠ¸
                Object.keys(retentionResult.cohort_analysis.monthly).forEach(cohort => {
                    const data = retentionResult.cohort_analysis.monthly[cohort];
                    Object.keys(data.retention).forEach(period => {
                        csv += `ì›”ë³„_ì½”í˜¸íŠ¸,${cohort},${data.cohort_size},${period},${data.retention[period]}\n`;
                    });
                });
            }

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'retention_report.csv';
            a.click();
        }

        // Google API ì´ˆê¸°í™”
        function gapiLoaded() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', initializeGapiClient);
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
            } catch (error) {
                console.error('Google API ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        function gisLoaded() {
            if (typeof google !== 'undefined' && google.accounts) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // ë‚˜ì¤‘ì— ì„¤ì •
                });
                gisInited = true;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // Google API ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            const checkAndInit = () => {
                if (typeof gapi !== 'undefined') {
                    gapiLoaded();
                } else {
                    setTimeout(checkAndInit, 100);
                }
            };
            
            const checkAndInitGis = () => {
                if (typeof google !== 'undefined' && google.accounts) {
                    gisLoaded();
                } else {
                    setTimeout(checkAndInitGis, 100);
                }
            };
            
            checkAndInit();
            checkAndInitGis();
        });

        // êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°
        async function exportToGoogleSheets() {
            if (!retentionResult) {
                alert('âš ï¸ ë¨¼ì € ë¦¬í…ì…˜ ë°ì´í„°ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
                return;
            }

            const statusEl = document.getElementById('googleSheetsStatus');
            const btn = document.getElementById('googleSheetsBtn');
            
            statusEl.textContent = 'ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘...';
            btn.disabled = true;

            // í† í° ìš”ì²­
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    statusEl.textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + resp.error;
                    btn.disabled = false;
                    return;
                }

                try {
                    statusEl.textContent = 'ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„± ì¤‘...';
                    
                    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
                    const createResponse = await gapi.client.sheets.spreadsheets.create({
                        properties: {
                            title: `ë¦¬í…ì…˜ ë¶„ì„ ê²°ê³¼ - ${new Date().toLocaleDateString('ko-KR')}`
                        },
                        sheets: [
                            { properties: { title: 'ì¼ë³„ ë¦¬í…ì…˜' } },
                            { properties: { title: 'ì£¼ë³„ ë¦¬í…ì…˜' } },
                            { properties: { title: 'ì›”ë³„ ë¦¬í…ì…˜' } },
                            { properties: { title: 'ì¼ë³„ ì½”í˜¸íŠ¸' } },
                            { properties: { title: 'ì£¼ë³„ ì½”í˜¸íŠ¸' } },
                            { properties: { title: 'ì›”ë³„ ì½”í˜¸íŠ¸' } },
                            { properties: { title: 'ìš”ì•½' } }
                        ]
                    });

                    const spreadsheetId = createResponse.result.spreadsheetId;
                    const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;

                    statusEl.textContent = 'âœï¸ ë°ì´í„° ì…ë ¥ ì¤‘...';

                    // ë°ì´í„° ì¤€ë¹„
                    const requests = [];

                    // ì¼ë³„ ë¦¬í…ì…˜
                    const dailyData = [
                        ['ê¸°ì¤€ì¼', 'ë¹„êµì¼', 'ê¸°ì¤€ì¼ êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨(%)'],
                        ...retentionResult.daily_retention.map(r => [
                            r.ê¸°ì¤€ì¼, r.ë¹„êµì¼, r.ê¸°ì¤€ì¼_êµ¬ë§¤ììˆ˜, r.ì¬êµ¬ë§¤ììˆ˜, r.ë¦¬í…ì…˜ìœ¨
                        ])
                    ];

                    // ì£¼ë³„ ë¦¬í…ì…˜
                    const weeklyData = [
                        ['ê¸°ì¤€ì£¼', 'ê¸°ì¤€ì£¼ ê¸°ê°„', 'ë¹„êµì£¼', 'ë¹„êµì£¼ ê¸°ê°„', 'ê¸°ì¤€ì£¼ êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨(%)'],
                        ...retentionResult.weekly_retention.map(r => [
                            r.ê¸°ì¤€ì£¼, r.ê¸°ì¤€ì£¼_ê¸°ê°„, r.ë¹„êµì£¼, r.ë¹„êµì£¼_ê¸°ê°„, r.ê¸°ì¤€ì£¼_êµ¬ë§¤ììˆ˜, r.ì¬êµ¬ë§¤ììˆ˜, r.ë¦¬í…ì…˜ìœ¨
                        ])
                    ];

                    // ì›”ë³„ ë¦¬í…ì…˜
                    const monthlyData = [
                        ['ê¸°ì¤€ì›”', 'ë¹„êµì›”', 'ê¸°ì¤€ì›” êµ¬ë§¤ììˆ˜', 'ì¬êµ¬ë§¤ììˆ˜', 'ë¦¬í…ì…˜ìœ¨(%)'],
                        ...retentionResult.monthly_retention.map(r => [
                            r.ê¸°ì¤€ì›”, r.ë¹„êµì›”, r.ê¸°ì¤€ì›”_êµ¬ë§¤ììˆ˜, r.ì¬êµ¬ë§¤ììˆ˜, r.ë¦¬í…ì…˜ìœ¨
                        ])
                    ];

                    // ìš”ì•½
                    const summaryData = [
                        ['í•­ëª©', 'ê°’'],
                        ['ë°ì´í„° ê¸°ê°„', retentionResult.metadata.data_period],
                        ['ì´ ê±°ë˜ ê±´ìˆ˜', retentionResult.metadata.total_records],
                        ['ìœ ë‹ˆí¬ êµ¬ë§¤ì', retentionResult.metadata.unique_buyers],
                        ['ì¼ë³„ í‰ê·  ë¦¬í…ì…˜', (retentionResult.daily_retention.reduce((s, r) => s + r.ë¦¬í…ì…˜ìœ¨, 0) / retentionResult.daily_retention.length).toFixed(2) + '%']
                    ];

                    // ì¼ë³„ ì½”í˜¸íŠ¸
                    let dailyCohortData = [['ì½”í˜¸íŠ¸', 'ì¸ì›', 'D+1', 'D+2', 'D+3', 'D+7', 'D+14', 'D+30']];
                    if (retentionResult.cohort_analysis) {
                        Object.keys(retentionResult.cohort_analysis.daily).forEach(cohort => {
                            const data = retentionResult.cohort_analysis.daily[cohort];
                            dailyCohortData.push([
                                cohort,
                                data.cohort_size,
                                data.retention['D+1'] || '',
                                data.retention['D+2'] || '',
                                data.retention['D+3'] || '',
                                data.retention['D+7'] || '',
                                data.retention['D+14'] || '',
                                data.retention['D+30'] || ''
                            ]);
                        });
                    }

                    // ì£¼ë³„ ì½”í˜¸íŠ¸
                    let weeklyCohortData = [['ì½”í˜¸íŠ¸', 'ì¸ì›', 'W+1', 'W+2', 'W+3', 'W+4']];
                    if (retentionResult.cohort_analysis) {
                        Object.keys(retentionResult.cohort_analysis.weekly).forEach(cohort => {
                            const data = retentionResult.cohort_analysis.weekly[cohort];
                            weeklyCohortData.push([
                                cohort,
                                data.cohort_size,
                                data.retention['W+1'] || '',
                                data.retention['W+2'] || '',
                                data.retention['W+3'] || '',
                                data.retention['W+4'] || ''
                            ]);
                        });
                    }

                    // ì›”ë³„ ì½”í˜¸íŠ¸ - ë™ì ìœ¼ë¡œ ì „ì²´ ê¸°ê°„ ê³„ì‚°
                    let monthlyPeriods = [];
                    if (retentionResult.cohort_analysis) {
                        const allPeriods = new Set();
                        Object.values(retentionResult.cohort_analysis.monthly).forEach(data => {
                            Object.keys(data.retention || {}).forEach(period => {
                                allPeriods.add(period);
                            });
                        });
                        // ê¸°ê°„ì„ ìˆ«ì ìˆœì„œëŒ€ë¡œ ì •ë ¬ (M+1, M+2, ... M+10)
                        monthlyPeriods = Array.from(allPeriods).sort((a, b) => {
                            const numA = parseInt(a.match(/\d+/)[0]);
                            const numB = parseInt(b.match(/\d+/)[0]);
                            return numA - numB;
                        });
                    }
                    
                    let monthlyCohortData = [['ì½”í˜¸íŠ¸', 'ì¸ì›', ...monthlyPeriods]];
                    if (retentionResult.cohort_analysis) {
                        Object.keys(retentionResult.cohort_analysis.monthly).forEach(cohort => {
                            const data = retentionResult.cohort_analysis.monthly[cohort];
                            const row = [
                                cohort,
                                data.cohort_size,
                                ...monthlyPeriods.map(period => data.retention[period] || '')
                            ];
                            monthlyCohortData.push(row);
                        });
                    }

                    // ë°ì´í„° ì—…ë°ì´íŠ¸
                    await gapi.client.sheets.spreadsheets.values.batchUpdate({
                        spreadsheetId: spreadsheetId,
                        resource: {
                            valueInputOption: 'RAW',
                            data: [
                                { range: 'ì¼ë³„ ë¦¬í…ì…˜!A1', values: dailyData },
                                { range: 'ì£¼ë³„ ë¦¬í…ì…˜!A1', values: weeklyData },
                                { range: 'ì›”ë³„ ë¦¬í…ì…˜!A1', values: monthlyData },
                                { range: 'ì¼ë³„ ì½”í˜¸íŠ¸!A1', values: dailyCohortData },
                                { range: 'ì£¼ë³„ ì½”í˜¸íŠ¸!A1', values: weeklyCohortData },
                                { range: 'ì›”ë³„ ì½”í˜¸íŠ¸!A1', values: monthlyCohortData },
                                { range: 'ìš”ì•½!A1', values: summaryData }
                            ]
                        }
                    });

                    statusEl.innerHTML = `âœ… ì™„ë£Œ! <a href="${spreadsheetUrl}" target="_blank" style="color: #34A853; font-weight: 600;">êµ¬ê¸€ ì‹œíŠ¸ ì—´ê¸° â†’</a>`;
                    btn.disabled = false;
                    
                    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì—´ê¸°
                    setTimeout(() => {
                        window.open(spreadsheetUrl, '_blank');
                    }, 1000);

                } catch (error) {
                    console.error('Error:', error);
                    statusEl.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
                    btn.disabled = false;
                }
            };

            if (gapi.client.getToken() === null) {
                // í† í°ì´ ì—†ìœ¼ë©´ ìš”ì²­
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                // í† í°ì´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }
    </script>
</body>
</html>
